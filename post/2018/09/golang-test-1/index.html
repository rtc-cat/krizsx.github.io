<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width"><script type=application/javascript src=https://krizsx.github.io/js/theme-mode.js></script>
<link rel=stylesheet href=https://krizsx.github.io/css/frameworks.min.css><link rel=stylesheet href=https://krizsx.github.io/css/github.min.css><link rel=stylesheet href=https://krizsx.github.io/css/github-style.css><link rel=stylesheet href=https://krizsx.github.io/css/light.css><link rel=stylesheet href=https://krizsx.github.io/css/dark.css><link rel=stylesheet href=https://krizsx.github.io/css/syntax.css><title>Go语言测试(一) - 摆烂</title><link rel=icon type=image/x-icon href=https://krizsx.github.io/images/favicon.ico><meta name=theme-color content="#1e2327"><meta name=description content="如何编写简单测试?
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://krizsx.github.io/post/2018/09/golang-test-1/><meta name=twitter:card content="summary"><meta name=twitter:title content="Go语言测试(一) - 摆烂"><meta name=twitter:description content="如何编写简单测试?
"><meta name=twitter:site content="https://krizsx.github.io"><meta name=twitter:creator content><meta name=twitter:image content="https://krizsx.github.io"><meta property="og:type" content="article"><meta property="og:title" content="Go语言测试(一) - 摆烂"><meta property="og:description" content="如何编写简单测试?
"><meta property="og:url" content="https://krizsx.github.io/post/2018/09/golang-test-1/"><meta property="og:site_name" content="Go语言测试(一)"><meta property="og:image" content="https://krizsx.github.io"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2018-09-30 16:57:12 +0800 +0800"></head><body><div style=position:relative><header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on"><div class="Header-item mobile-none" style=margin-top:-4px;margin-bottom:-4px><a class=Header-link href=https://krizsx.github.io><svg class="octicon" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class="Header-item d-md-none"><button class="Header-link btn-link js-details-target" type=button onclick='document.querySelector("#header-search").style.display=document.querySelector("#header-search").style.display=="none"?"block":"none"'><svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button></div><div style=display:none id=header-search class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex"><div class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to"><div class=position-relative><form target=_blank action=https://www.google.com/search accept-charset=utf-8 method=get autocomplete=off><label class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center"><input type=text class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable" name=q placeholder=Search autocomplete=off>
<input type=hidden name=q value=site:https://krizsx.github.io></label></form></div></div></div><div class="Header-item Header-item--full flex-justify-center d-md-none position-relative"><a class=Header-link href=https://krizsx.github.io><svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class=Header-item style=margin-right:0><a href=javascript:void(0) class="Header-link no-select" onclick=switchTheme()><svg style="fill:var(--color-profile-color-modes-toggle-moon)" class="no-select" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.52208 7.71754c3.05612.0 5.53362-2.47748 5.53362-5.5336C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961 9.95801 1.07727 10.3495.771159 10.6474.99992c1.4679 1.12724 2.4141 2.90007 2.4141 4.89391.0 3.40575-2.7609 6.16667-6.16665 6.16667-2.94151.0-5.40199-2.0595-6.018122-4.81523C.794841 6.87902 1.23668 6.65289 1.55321 6.85451 2.41106 7.40095 3.4296 7.71754 4.52208 7.71754z"/></svg></a></div></header></div><div><main><div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4"><div class=px-0><div class="mb-3 d-flex px-3 px-md-3 px-lg-5"><div class="flex-auto min-width-0 width-fit mr-3"><div class=d-flex><div class="d-none d-md-block"><a class="avatar mr-2 flex-shrink-0" href=https://krizsx.github.io><img class=avatar-user src=/img/avator.jpeg width=32 height=32></a></div><div class="d-flex flex-column"><h1 class="break-word f3 text-normal mb-md-0 mb-1"><span class=author><a href=https://krizsx.github.io>KrizsX</a></span><span class=path-divider>/</span><strong class="css-truncate-target mr-1" style=max-width:410px><a href=https://krizsx.github.io/post/2018/09/golang-test-1/>Go语言测试(一)</a></strong></h1><div class="note m-0">Created <relative-time datetime="Sun, 30 Sep 2018 16:57:12 +0800" class=no-wrap>Sun, 30 Sep 2018 16:57:12 +0800</relative-time>
<span class=file-info-divider></span>
Modified <relative-time datetime="Sun, 30 Sep 2018 16:57:12 +0800" class=no-wrap>Sun, 30 Sep 2018 16:57:12 +0800</relative-time></div></div></div></div></div></div></div><div class="container-lg px-3 new-discussion-timeline"><div class="repository-content gist-content"><div><div class="js-gist-file-update-container js-task-list-container file-box"><div id=file-pytest class="file my-2"><div id=post-header class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style=z-index:2><div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0"><summary id=toc-toggle onclick=clickToc() class="btn btn-octicon m-0 mr-2 p-2"><svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered"><path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zM3 8A1 1 0 111 8a1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"/></svg></summary><details-menu class=SelectMenu id=toc-details style="display: none;"><div class="SelectMenu-modal rounded-3 mt-1" style=max-height:340px><div class="SelectMenu-list SelectMenu-list--borderless p-2" style=overscroll-behavior:contain id=toc-list></div></div></details-menu>3393 Words</div><div class="file-actions flex-order-2 pt-0"><a class="muted-link mr-3" href=/tags/go><svg class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg>go</a>
<a class="muted-link mr-3" href=/tags/testing><svg class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg>testing</a></div></div></div><div class="Box-body px-5 pb-5" style=z-index:1><article class="markdown-body entry-content container-lg"><p>如何编写简单测试?</p><h1 id=go-语言测试>Go 语言测试</h1><h2 id=自带测试介绍>自带测试介绍</h2><p>Go 语言自己有一个轻量级的测试框架,由<code>go test</code>命令以及<code>testing</code>包组成</p><p>通过创建以<code>_test.go</code>为结尾的文件来编写对应文件的测试用例,该文件中应该包含名字为<code>TestXXX</code>,并且参数为<code>(t *testing)</code>的函数,那么执行<code>go test</code>命令的时候就会执行这些函数,如果在测试函数中调用了<code>t.Error</code>或者<code>t.Fail</code>,则认为测试用例失败</p><p>我个人认为,Go 语言的测试可以大致分为内部测试和外部测试两类:</p><ul><li>外部测试:指的是测试代码和源代码在不同的包,名名规范应该是 <code>_test.go</code></li><li>内部测试:指的是测试代码和源代码在是同一个包,命名规范应该是 <code>_internal_test.go</code></li></ul><p>我觉得大部分的测试应该是属于外部测试,就是只需要测试这个包大写的函数即可,如果有测试 private 函数的必要的话,可以再创建一个文件来写内部测试</p><p>下面举个小栗子:</p><p>写一个进行加法运算的函数</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Package integers 整数计算
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>integers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Sum 求和
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Sum</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>y</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=单元测试unit-test>单元测试(Unit Test)</h3><p>那么就可以编写一个下面这样的测试用例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>integers_test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;demo/integers&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestSum</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>actual</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>integers</span>.<span style=color:#a6e22e>Sum</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>expected</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>actual</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>expected</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;expected &#39;%d&#39; but got &#39;%d&#39;&#34;</span>, <span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>actual</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>接下来可以执行<code>go test -v</code>执行测试用例,看到这样的输出就表示测试通过</p><p><img src=/img/2018/09/integers_test.png alt="sum test"></p><p>Go 语言测试中还支持写一个<code>Example</code>来说明函数的作用,并且会被写到<code>godoc</code>中方便查看,就以上面这个函数为例子</p><p><code>Example</code>的语法是,函数名以<code>Example</code>开头,不需要参数,最后注释中有一个<code>Output:</code>来表示预期输出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ExampleSum</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>actual</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>integers</span>.<span style=color:#a6e22e>Sum</span>(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>actual</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Output: 3
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>这样就可以了,之后再执行一次<code>go test -v</code></p><p><img src=/img/2018/09/integers_example.png alt="sum example"></p><p>再之后,可以通过</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>godoc -http<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;:6060&#34;</span>
</span></span></code></pre></div><blockquote><p>godoc 命令可以扫描所有 GOPATH 以及 GOROOT 中的包,并且生成这样一个文档</p></blockquote><p>这个命令来启动文档,之后呢访问<a href=http://localhost:6060/pkg/demo/integers/>http://localhost:6060/pkg/demo/integers/</a></p><p>会看到这样一个页面</p><p><img src=/img/2018/09/integers_doc.png alt="integers doc"></p><h3 id=压力测试benchmark-test>压力测试(Benchmark Test)</h3><p>还是以上面的 Sum 函数来编写一个压力测试,与普通的测试用例很像,只是函数名和参数需要替换一下</p><p>举个栗子:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkSum</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>integers</span>.<span style=color:#a6e22e>Sum</span>(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>压力测试函数的前缀要变成<code>Benchmark</code>,并且参数变成<code>b *testing.B</code>,之后可以通过<code>b.N</code>来决定执行次数,至于具体会执行多少次,这个是<code>testing</code>包来决定,它会找到最合适的值,那接下来就可以使用<code>go test -v -bench=.</code>来执行压力测试</p><p><img src=/img/2018/09/integers_benchmark.png alt="integers benchmark"></p><p>这里显示最后的结果就是,执行一次<code>Sum</code>函数,需要 0.29 纳秒,一共执行了 2000000000 次</p><h3 id=子测试sub-test>子测试(Sub Test)</h3><p>在测试用例中,可以通过调用<code>t.Run</code>来执行一次子测试,有时候对于一个事情,会有不同的场景,那么就可以利用子测试来进行描述,并且可以复用代码</p><p>继续以上面的<code>Sum</code>函数来举栗子</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestSumMulti</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>assert</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>actual</span>, <span style=color:#a6e22e>expected</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 这里调用Helper函数表示当前函数并不是一个真正的测试用例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// 在输出错误行号时,会将调用该函数的函数的位置打印出,而不是打印在Helper函数中的行号
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Helper</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>actual</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>expected</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;expected &#39;%d&#39; but got &#39;%d&#39;&#34;</span>, <span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>actual</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;2+2&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>actual</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>integers</span>.<span style=color:#a6e22e>Sum</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>expected</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>5</span> <span style=color:#75715e>// 这里故意失败一下
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>assert</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>actual</span>, <span style=color:#a6e22e>expected</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;3+3&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>actual</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>integers</span>.<span style=color:#a6e22e>Sum</span>(<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>expected</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>assert</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>actual</span>, <span style=color:#a6e22e>expected</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>然后运行<code>go test -v</code>可以看到</p><p><img src=/img/2018/09/integers_sub.png alt="sub test"></p><h3 id=表格驱动-table-drivenhttpsgithubcomgolanggowikitabledriventests>表格驱动 <a href=https://github.com/golang/go/wiki/TableDrivenTests>Table-Driven</a></h3><p>表格驱动是 Go 语言非常推荐的一种测试方式,这种方式可以很清晰的看到输入与输出,并且 Go 语言的 struct 很适合编写表格驱动的测试用例,此外,当发现了错误的时候,也可以很轻松的修改测试用例</p><p>继续以上面的<code>Sum</code>函数举栗子:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestSumTableDriven</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 定义一个struct,用来表示参数以及期望输出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>name</span>     <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>x</span>        <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>y</span>        <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>expected</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>	}{
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;1+1&#34;</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>}, <span style=color:#75715e>// 表格中的每一条,包含输入的参数以及期望的输出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		{<span style=color:#e6db74>&#34;2+3&#34;</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>5</span>},
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;4+5&#34;</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>9</span>},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 利用子测试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>actual</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>integers</span>.<span style=color:#a6e22e>Sum</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>y</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>actual</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>expected</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;expected &#39;%d&#39; but got &#39;%d&#39;&#34;</span>, <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>actual</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这样写的好处就很明显了,当你需要添加删除或者修改测试用例的参数,都可以直接修改表格中的数据,而不需要修改代码,而且使测试用例的代码非常地简介明了</p><h2 id=testify>Testify</h2><p>上面的写法都是 Go 语言自身提供的写法,但是在编写测试的时候就会发现,它有很多不足,所以我安利一个第三方的测试框架,叫做<a href=https://github.com/stretchr/testify>Testify</a></p><p>我自己常用的是下面三个包</p><ul><li>assert 用来判断结果是否符合期望,如果不符合会标记测试用例为失败,但是会继续执行</li><li>require 和 assert 功能一样,但是如果不符合的话会立即终止测试程序</li><li>mock 用来模拟一个假的实现对象</li></ul><h3 id=重构>重构</h3><p>下面就用这个包来重构一下刚才的代码</p><p>最开始的<code>TestSum</code>可以写成这样</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestSum</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>actual</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>integers</span>.<span style=color:#a6e22e>Sum</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expected</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Equal 函数可以判断是否相等,如果不相等,就会标记为失败
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>actual</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 替换成require就是这样,函数和参数完全一致
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// require.Equal(t, expected, actual)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><code>TableDriven</code>可以写成这样</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestSumTableDriven</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 定义一个struct,用来表示参数以及期望输出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>name</span>     <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>x</span>        <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>y</span>        <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>expected</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>	}{
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;1+1&#34;</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>},
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;2+3&#34;</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>5</span>},
</span></span><span style=display:flex><span>		{<span style=color:#e6db74>&#34;4+5&#34;</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>9</span>},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>integers</span>.<span style=color:#a6e22e>Sum</span>(<span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>y</span>))
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>代码简洁了很多</p><h3 id=mock-测试>Mock 测试</h3><p>mock 测试就是模拟一个对象来实现功能,为什么需要这个对象,是因为有时候不可以直接调用真正的实现,所以需要一个假的对象来代替,testify 的 mock 包就可以做到,举个栗子:</p><p>假设现在有一段调用 redis 的代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>mock</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;github.com/mediocregopher/radix.v2/redis&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Handler 调用redis
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Handler</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>DB</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Client</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Ping 给redis发送一个命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Handler</span>) <span style=color:#a6e22e>Ping</span>() (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 这里是真的redis客户端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>res</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>DB</span>.<span style=color:#a6e22e>Cmd</span>(<span style=color:#e6db74>&#34;INCR&#34;</span>, <span style=color:#e6db74>&#34;ping&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;pong&#34;</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>按照这种写法,如果直接对 Handler 的 Ping 函数进行单元测试,那么肯定就需要创建一个 redis 的 client 去连接 redis 了,这明显是不符合要求的,所以需要对代码进行一下改造,将调用抽象为接口</p><p>因为调用 redisClient 的<code>Cmd</code>函数,所以定义这么一个接口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>mock</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;github.com/mediocregopher/radix.v2/redis&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// RedisCaller 抽象出一个接口,这个接口是我们需要调用的,并且已经被真正的redis client实现,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RedisCaller</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Cmd</span>(<span style=color:#a6e22e>cmd</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) <span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Resp</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Handler 调用redis
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Handler</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>DB</span> <span style=color:#a6e22e>RedisCaller</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Ping 给redis发送一个命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Handler</span>) <span style=color:#a6e22e>Ping</span>() (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 这里是真的redis客户端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>res</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>DB</span>.<span style=color:#a6e22e>Cmd</span>(<span style=color:#e6db74>&#34;INCR&#34;</span>, <span style=color:#e6db74>&#34;ping&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;pong&#34;</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>之后通过<code>mock</code>包,编写一个 mock 对象来实现对应的接口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>mock_test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>my</span> <span style=color:#e6db74>&#34;demo/mock&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/mediocregopher/radix.v2/redis&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/stretchr/testify/mock&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>mockRedisCaller</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mock</span>.<span style=color:#a6e22e>Mock</span> <span style=color:#75715e>// 只需要组合testify的mock包
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Cmd 实现接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mockRedisCaller</span>) <span style=color:#a6e22e>Cmd</span>(<span style=color:#a6e22e>cmd</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) <span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Resp</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_ca</span> []<span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_ca</span> = append(<span style=color:#a6e22e>_ca</span>, <span style=color:#a6e22e>cmd</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_ca</span> = append(<span style=color:#a6e22e>_ca</span>, <span style=color:#a6e22e>args</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 这里是假装接收所有参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>_args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Called</span>(<span style=color:#a6e22e>_ca</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 这里是假装返回一个结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Get 函数的参数指的是传入结果的index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>_args</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#ae81ff>0</span>).(<span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Resp</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestPing</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sampleErr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;错误&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>name</span>     <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>response</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span>      <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	}{
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>name</span>:     <span style=color:#e6db74>&#34;success&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>response</span>: <span style=color:#e6db74>&#34;pong&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>err</span>:      <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>name</span>:     <span style=color:#e6db74>&#34;fail&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>response</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>err</span>:      <span style=color:#a6e22e>sampleErr</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>test</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Logf</span>(<span style=color:#e6db74>&#34;Running test case: %s&#34;</span>, <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>caller</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mockRedisCaller</span>{}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 这个On表示的就是当调用 Cmd这个函数,并且参数是 INCR ping:count的时候
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>caller</span>.<span style=color:#a6e22e>On</span>(<span style=color:#e6db74>&#34;Cmd&#34;</span>, <span style=color:#e6db74>&#34;INCR&#34;</span>, <span style=color:#e6db74>&#34;ping&#34;</span>).
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Return表示返回什么样的结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>Return</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Resp</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Err</span>: <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>			}).<span style=color:#a6e22e>Once</span>()
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 这里再创建之前需要测试的Handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>h</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>my</span>.<span style=color:#a6e22e>Handler</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>DB</span>: <span style=color:#a6e22e>caller</span>,
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 这样调用Ping的时候,就会调用上面刚刚声明的caller了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>Ping</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>test</span>.<span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>response</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>接下来运行<code>go test -v</code></p><p><img src=/img/2018/09/mock_test.png alt="mock test"></p><p>这样就实现了替换掉真正的实现,而是用 mock 对象代替调用</p><h3 id=mock-生成器>Mock 生成器</h3><p>每次编写这样一个对象其实是很浪费时间的,所以这里安利一个 mock 对象生成器<a href=https://github.com/vektra/mockery>mockery</a></p><p>安装方式:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>go get -u github.com/vektra/mockery
</span></span><span style=display:flex><span>cd $GOPATH/github.com/vektra/mockery/cmd/mockery
</span></span><span style=display:flex><span>go install
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mockery --help
</span></span><span style=display:flex><span>Usage of mockery:
</span></span><span style=display:flex><span>  -all
</span></span><span style=display:flex><span>        generates mocks <span style=color:#66d9ef>for</span> all found interfaces in all sub-directories
</span></span><span style=display:flex><span>  -case string
</span></span><span style=display:flex><span>        name the mocked file using casing convention <span style=color:#f92672>[</span>camel, snake, underscore<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>default <span style=color:#e6db74>&#34;camel&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -cpuprofile string
</span></span><span style=display:flex><span>        write cpu profile to file
</span></span><span style=display:flex><span>  -dir string
</span></span><span style=display:flex><span>        directory to search <span style=color:#66d9ef>for</span> interfaces <span style=color:#f92672>(</span>default <span style=color:#e6db74>&#34;.&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -inpkg
</span></span><span style=display:flex><span>        generate a mock that goes inside the original package
</span></span><span style=display:flex><span>  -keeptree
</span></span><span style=display:flex><span>        keep the tree structure of the original interface files into a different repository. Must be used with XX
</span></span><span style=display:flex><span>  -name string
</span></span><span style=display:flex><span>        name or matching regular expression of interface to generate mock <span style=color:#66d9ef>for</span>
</span></span><span style=display:flex><span>  -note string
</span></span><span style=display:flex><span>        comment to insert into prologue of each generated file
</span></span><span style=display:flex><span>  -outpkg string
</span></span><span style=display:flex><span>        name of generated package <span style=color:#f92672>(</span>default <span style=color:#e6db74>&#34;mocks&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -output string
</span></span><span style=display:flex><span>        directory to write mocks to <span style=color:#f92672>(</span>default <span style=color:#e6db74>&#34;./mocks&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -print
</span></span><span style=display:flex><span>        print the generated mock to stdout
</span></span><span style=display:flex><span>  -quiet
</span></span><span style=display:flex><span>        suppress output to stdout
</span></span><span style=display:flex><span>  -recursive
</span></span><span style=display:flex><span>        recurse search into sub-directories
</span></span><span style=display:flex><span>  -tags string
</span></span><span style=display:flex><span>        space-separated list of additional build tags to use
</span></span><span style=display:flex><span>  -testonly
</span></span><span style=display:flex><span>        generate a mock in a _test.go file
</span></span><span style=display:flex><span>  -version
</span></span><span style=display:flex><span>        prints the installed version of mockery
</span></span></code></pre></div><p>使用方式非常简单,只需要到需要生成的目录,执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mockery -all -testonly
</span></span></code></pre></div><p>以上面的<code>mock</code>包为例,执行命令之后就会出现</p><p><img src=/img/2018/09/mock_generator.png alt=mockery></p><p>生成的代码是这样的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Code generated by mockery v1.0.0. DO NOT EDIT.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>mocks</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#a6e22e>mock</span> <span style=color:#e6db74>&#34;github.com/stretchr/testify/mock&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#a6e22e>redis</span> <span style=color:#e6db74>&#34;github.com/mediocregopher/radix.v2/redis&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// RedisCaller is an autogenerated mock type for the RedisCaller type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RedisCaller</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mock</span>.<span style=color:#a6e22e>Mock</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Cmd provides a mock function with given fields: cmd, args
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>_m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RedisCaller</span>) <span style=color:#a6e22e>Cmd</span>(<span style=color:#a6e22e>cmd</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) <span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Resp</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_ca</span> []<span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_ca</span> = append(<span style=color:#a6e22e>_ca</span>, <span style=color:#a6e22e>cmd</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_ca</span> = append(<span style=color:#a6e22e>_ca</span>, <span style=color:#a6e22e>args</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ret</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>_m</span>.<span style=color:#a6e22e>Called</span>(<span style=color:#a6e22e>_ca</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>r0</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Resp</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ret</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#ae81ff>0</span>).(<span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>string</span>, <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) <span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Resp</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>r0</span> = <span style=color:#a6e22e>rf</span>(<span style=color:#a6e22e>cmd</span>, <span style=color:#a6e22e>args</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ret</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#ae81ff>0</span>) <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>r0</span> = <span style=color:#a6e22e>ret</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#ae81ff>0</span>).(<span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Resp</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>r0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这样就不需要自己编写 mock 对象了,省了很多时间</p><hr><h2 id=测试覆盖率>测试覆盖率</h2><p>相信通过上面的方法已经可以写出很多测试用例了,接下来就可以对这些测试进行一些分析,例如生成测试率报告</p><p>就以刚才那个 mock 测试为例,首先,在<code>go test</code>命令执行时添加<code>-cover</code>参数就可以直接看到覆盖率了</p><p>执行命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>go test -v -cover
</span></span></code></pre></div><p><img src=/img/2018/09/mock_cover.png alt="mock cover"></p><p>可以看到测试覆盖率是 100%,证明了测试用例中,成功和失败的都覆盖到了</p><p>还可以通过<code>-coverprofile</code>生成一份报告</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>go test -covermode<span style=color:#f92672>=</span>count -coverprofile<span style=color:#f92672>=</span>cover.out
</span></span></code></pre></div><p>这样就可以在当前目录生成一份覆盖率报告了,之后可以通过<code>go tool cover</code>来进行分析</p><p>比如说,分析每个函数的覆盖率</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>go tool cover -func<span style=color:#f92672>=</span>cover.out
</span></span></code></pre></div><p>会看到下面的结果</p><p><img src=/img/2018/09/mock_cover_func.png alt="mock cover func"></p><p>还可以使用命令来生成一个 html 页面</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>go tool cover -html<span style=color:#f92672>=</span>cover.out
</span></span></code></pre></div><p><img src=/img/2018/09/mock_cover_html.png alt="mock cover web"></p><hr><p>第一篇 Go 语言测试简单介绍了如何编写简单的测试用例,并且生成覆盖率报告,之后的内容会介绍如何编写可以测试的代码,通过抽象接口,拆分实现,来让你的代码尽可能的可以测试,保证自己代码的健壮性,还有就是利用 Docker 以及 docker-compose 进行级联测试等</p></article></div></div></div></div></div></div></main></div><script type=application/javascript src=https://krizsx.github.io/js/toc.js></script>
<link rel=stylesheet href=https://krizsx.github.io/css/toc.css><script src=https://utteranc.es/client.js repo=krizsx/krizsx.github.io issue-term=pathname theme=github-dark crossorigin=anonymous async></script><div class="footer container-xl width-full p-responsive"><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><a aria-label=Homepage title=GitHub class="footer-octicon d-none d-lg-block mr-lg-4" href=https://krizsx.github.io><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"><li class="mr-3 mr-lg-0">Theme by <a href=https://github.com/MeiK2333/github-style>github-style</a></li></ul></div><div class="d-flex flex-justify-center pb-6"><span class="f6 text-gray-light"></span></div></div></body><script type=application/javascript src=https://krizsx.github.io/js/github-style.js></script></html>